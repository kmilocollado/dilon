---
import Layout from "@/layouts/Layout.astro";
import { getProjectsImage } from "@/pods/projects-collection/projects-collection.api";
import type { ProjectsCollection } from "@/pods/projects-collection/projects-collection.model";

export async function getStaticPaths() {
    const projectsImage = await getProjectsImage();
    
    return projectsImage.map((project) => ({
        params: { slug: project.slug },
        props: { project },
    }));
}

interface Props {
    project: ProjectsCollection;
}

const { project } = Astro.props;
const images = project.project?.images || [];
const projectName = project.project?.namecollection || 'Proyecto sin título';
---

<Layout>
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
        <!-- Header -->
        <div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <a 
                        href="/projects"
                        class="flex items-center text-gray-600 hover:text-purple-600 transition-colors group"
                    >
                        <svg class="w-5 h-5 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Volver a proyectos
                    </a>
                    <span class="text-sm text-gray-500">{images.length} imágenes</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
            <!-- Title -->
            <div class="text-center mb-12">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                    {projectName}
                </h1>
                <p class="text-gray-600">Explora la colección completa</p>
            </div>

            <!-- Gallery Grid -->
            {images.length > 0 ? (
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8">
                    {images.map((image, index) => (
                        <div 
                            class="group relative aspect-square bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer"
                            data-index={index}
                        >
                            <img 
                                src={image.url} 
                                alt={`${projectName} - Imagen ${index + 1}`}
                                loading="lazy"
                                class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
                            />
                            <!-- Overlay with index -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center pb-4">
                                <span class="text-white font-semibold text-lg">
                                    {index + 1} / {images.length}
                                </span>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div class="text-center py-20">
                    <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <h3 class="text-xl text-gray-500 mb-2">No hay imágenes disponibles</h3>
                    <p class="text-gray-400">Este proyecto aún no tiene imágenes cargadas</p>
                </div>
            )}
        </div>

        <!-- Lightbox Modal -->
        <div 
            id="lightbox" 
            class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4"
        >
            <!-- Close button -->
            <button 
                id="closeLightbox"
                class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10"
                aria-label="Cerrar"
            >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Previous button -->
            <button 
                id="prevImage"
                class="absolute left-4 text-white hover:text-gray-300 transition-colors"
                aria-label="Anterior"
            >
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>

            <!-- Image container -->
            <div class="max-w-7xl max-h-[90vh] flex flex-col items-center">
                <img 
                    id="lightboxImage" 
                    src="" 
                    alt="" 
                    class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl"
                />
                <p id="lightboxCaption" class="text-white mt-4 text-center text-lg"></p>
            </div>

            <!-- Next button -->
            <button 
                id="nextImage"
                class="absolute right-4 text-white hover:text-gray-300 transition-colors"
                aria-label="Siguiente"
            >
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>
</Layout>

<script define:vars={{ images, projectName }}>
    // Lightbox functionality
    let currentImageIndex = 0;
    
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxCaption = document.getElementById('lightboxCaption');
    const closeLightboxBtn = document.getElementById('closeLightbox');
    const prevImageBtn = document.getElementById('prevImage');
    const nextImageBtn = document.getElementById('nextImage');
    const galleryItems = document.querySelectorAll('[data-index]');

    function openLightbox(index) {
        currentImageIndex = index;
        updateLightboxImage();
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = 'auto';
    }

    function updateLightboxImage() {
        if (images[currentImageIndex]) {
            lightboxImage.src = images[currentImageIndex].url;
            lightboxImage.alt = `${projectName} - Imagen ${currentImageIndex + 1}`;
            lightboxCaption.textContent = `${currentImageIndex + 1} / ${images.length}`;
        }
    }

    function showNextImage() {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateLightboxImage();
    }

    function showPrevImage() {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateLightboxImage();
    }

    // Event listeners
    galleryItems.forEach((item) => {
        item.addEventListener('click', () => {
            const index = parseInt(item.getAttribute('data-index'));
            openLightbox(index);
        });
    });

    closeLightboxBtn?.addEventListener('click', closeLightbox);
    nextImageBtn?.addEventListener('click', showNextImage);
    prevImageBtn?.addEventListener('click', showPrevImage);

    // Close lightbox when clicking outside the image
    lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox) {
            closeLightbox();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('hidden')) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') showNextImage();
            if (e.key === 'ArrowLeft') showPrevImage();
        }
    });
</script>

